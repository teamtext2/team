<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Magic Image Editor - Chỉnh sửa ảnh chuyên nghiệp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: 'Inter', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      overflow: hidden;
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 20px rgba(0,0,0,0.1);
      position: relative;
      z-index: 10;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid #475569;
      text-align: center;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 20px;
      color: white;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .app-subtitle {
      font-size: 12px;
      opacity: 0.7;
      font-weight: 400;
    }

    .sidebar-nav {
      padding: 20px;
      flex: 1;
    }

    .nav-section {
      margin-bottom: 32px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.6;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      font-size: 14px;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateX(4px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .nav-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      font-size: 16px;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #475569;
    }

    .export-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .main {
      display: flex;
      flex: 1;
      background: #f8fafc;
    }

    .tools-panel {
      width: 320px;
      background: white;
      border-right: 1px solid #e2e8f0;
      padding: 24px;
      overflow-y: auto;
    }

    .panel-header {
      margin-bottom: 24px;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1e293b;
    }

    .panel-subtitle {
      font-size: 14px;
      color: #64748b;
      font-weight: 400;
    }

    .control-group {
      margin-bottom: 32px;
    }

    .control-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #374151;
    }

    .control-value {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      text-align: center;
    }

    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e5e7eb;
      outline: none;
      -webkit-appearance: none;
      margin: 16px 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .canvas-container {
      flex: 1;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      position: relative;
    }

    .canvas-wrapper {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }

    .canvas-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .canvas-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .upload-btn {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    canvas {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .placeholder {
      text-align: center;
      color: #64748b;
      font-size: 16px;
      padding: 60px 20px;
    }

    .placeholder i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .hidden {
      display: none;
    }

    .coming-soon {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      color: #92400e;
    }

    .coming-soon i {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .coming-soon h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .coming-soon p {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
      .sidebar {
        width: 240px;
      }
      
      .tools-panel {
        width: 280px;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 16px;
      }
      
      .main {
        flex-direction: column;
      }
      
      .tools-panel {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fas fa-magic"></i>
      </div>
      <div class="app-title">Magic Image</div>
      <div class="app-subtitle">Photo Editor Pro</div>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Chỉnh sửa</div>
        <div class="nav-item active" onclick="showMenu('filters')">
          <i class="fas fa-filter"></i>
          Hiệu ứng
        </div>
        <div class="nav-item" onclick="showMenu('light')">
          <i class="fas fa-sun"></i>
          Ánh sáng
        </div>
        <div class="nav-item" onclick="showMenu('color')">
          <i class="fas fa-palette"></i>
          Màu sắc
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Công cụ</div>
        <div class="nav-item" onclick="showMenu('text')">
          <i class="fas fa-font"></i>
          Văn bản
        </div>
        <div class="nav-item" onclick="showMenu('draw')">
          <i class="fas fa-paint-brush"></i>
          Vẽ
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="export-btn" onclick="exportImage()">
        <i class="fas fa-download"></i>
        Xuất ảnh
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Tools Panel -->
    <div class="tools-panel">
      <div id="filters" class="control-group">
        <div class="panel-header">
          <div class="panel-title">Hiệu ứng</div>
          <div class="panel-subtitle">Áp dụng các bộ lọc nghệ thuật</div>
        </div>
        
        <label class="control-label">Chọn hiệu ứng</label>
        <select onchange="applyFilter(this.value)">
          <option value="">-- Chọn hiệu ứng --</option>
          <option value="vintage">Vintage</option>
          <option value="lomo">Lomo</option>
          <option value="clarity">Clarity</option>
          <option value="sunrise">Sunrise</option>
          <option value="pinhole">Pinhole</option>
          <option value="love">Love</option>
          <option value="grungy">Grungy</option>
          <option value="oldBoot">Old Boot</option>
        </select>
      </div>

      <div id="light" class="control-group hidden">
        <div class="panel-header">
          <div class="panel-title">Ánh sáng</div>
          <div class="panel-subtitle">Điều chỉnh ánh sáng và tương phản</div>
        </div>
        
        <label class="control-label">Độ sáng (Brightness)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('brightness', this.value)">
        <div class="control-value" id="brightness-value">0</div>

        <label class="control-label">Độ tương phản (Contrast)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('contrast', this.value)">
        <div class="control-value" id="contrast-value">0</div>

        <label class="control-label">Độ phơi sáng (Exposure)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('exposure', this.value)">
        <div class="control-value" id="exposure-value">0</div>

        <label class="control-label">Vùng sáng (Highlights)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('highlights', this.value)">
        <div class="control-value" id="highlights-value">0</div>

        <label class="control-label">Vùng tối (Shadows)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('shadows', this.value)">
        <div class="control-value" id="shadows-value">0</div>

        <label class="control-label">Nhiệt độ màu (Temperature)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustLighting('temperature', this.value)">
        <div class="control-value" id="temperature-value">0</div>

        <label class="control-label">Gamma</label>
        <input type="range" min="0.1" max="3.0" step="0.1" value="1.0" oninput="adjustLighting('gamma', this.value)">
        <div class="control-value" id="gamma-value">1.0</div>

        <div style="margin-top: 20px;">
          <label class="control-label">Hiệu ứng ánh sáng</label>
          <select onchange="applyLightingPreset(this.value)" style="margin-bottom: 12px;">
            <option value="">-- Chọn hiệu ứng --</option>
            <option value="warm">Ấm áp (Warm)</option>
            <option value="cool">Mát mẻ (Cool)</option>
            <option value="dramatic">Kịch tính (Dramatic)</option>
            <option value="soft">Nhẹ nhàng (Soft)</option>
            <option value="vintage">Cổ điển (Vintage)</option>
            <option value="high-contrast">Tương phản cao</option>
            <option value="low-key">Tối (Low Key)</option>
            <option value="high-key">Sáng (High Key)</option>
          </select>
          
          <button onclick="resetLighting()" style="
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
          ">Đặt lại ánh sáng</button>
        </div>
      </div>

      <div id="color" class="control-group hidden">
        <div class="panel-header">
          <div class="panel-title">Màu sắc</div>
          <div class="panel-subtitle">Điều chỉnh màu sắc và độ bão hòa</div>
        </div>
        
        <label class="control-label">Màu sắc (Hue)</label>
        <input type="range" min="0" max="360" value="0" oninput="adjustColor('hue', this.value)">
        <div class="control-value" id="hue-value">0°</div>

        <label class="control-label">Độ bão hòa (Saturation)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('saturation', this.value)">
        <div class="control-value" id="saturation-value">0</div>

        <label class="control-label">Độ sáng (Lightness)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('lightness', this.value)">
        <div class="control-value" id="lightness-value">0</div>

        <label class="control-label">Độ tương phản màu (Color Contrast)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('colorContrast', this.value)">
        <div class="control-value" id="colorContrast-value">0</div>

        <label class="control-label">Độ sắc nét màu (Color Sharpness)</label>
        <input type="range" min="0" max="100" value="0" oninput="adjustColor('colorSharpness', this.value)">
        <div class="control-value" id="colorSharpness-value">0</div>

        <label class="control-label">Độ mờ màu (Color Blur)</label>
        <input type="range" min="0" max="20" value="0" oninput="adjustColor('colorBlur', this.value)">
        <div class="control-value" id="colorBlur-value">0</div>

        <label class="control-label">Độ nhiễu màu (Color Noise)</label>
        <input type="range" min="0" max="50" value="0" oninput="adjustColor('colorNoise', this.value)">
        <div class="control-value" id="colorNoise-value">0</div>

        <label class="control-label">Độ phân tách màu (Color Separation)</label>
        <input type="range" min="0" max="10" value="0" oninput="adjustColor('colorSeparation', this.value)">
        <div class="control-value" id="colorSeparation-value">0</div>

        <label class="control-label">Độ chuyển màu (Color Transition)</label>
        <input type="range" min="0" max="100" value="0" oninput="adjustColor('colorTransition', this.value)">
        <div class="control-value" id="colorTransition-value">0</div>

        <label class="control-label">Độ ấm lạnh (Warmth)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('warmth', this.value)">
        <div class="control-value" id="warmth-value">0</div>

        <label class="control-label">Độ tươi mới (Vibrance)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('vibrance', this.value)">
        <div class="control-value" id="vibrance-value">0</div>

        <label class="control-label">Độ trong suốt (Opacity)</label>
        <input type="range" min="0" max="100" value="100" oninput="adjustColor('opacity', this.value)">
        <div class="control-value" id="opacity-value">100</div>

        <label class="control-label">Độ rõ nét (Clarity)</label>
        <input type="range" min="-100" max="100" value="0" oninput="adjustColor('clarity', this.value)">
        <div class="control-value" id="clarity-value">0</div>

        <div style="margin-top: 20px;">
          <label class="control-label">Hiệu ứng màu sắc</label>
          <select onchange="applyColorPreset(this.value)" style="margin-bottom: 12px;">
            <option value="">-- Chọn hiệu ứng --</option>
            <option value="vibrant">Rực rỡ (Vibrant)</option>
            <option value="muted">Nhẹ nhàng (Muted)</option>
            <option value="sepia">Cổ điển (Sepia)</option>
            <option value="blackwhite">Đen trắng (B&W)</option>
            <option value="crossProcess">Cross Process</option>
            <option value="chrome">Chrome</option>
            <option value="fade">Fade</option>
            <option value="instant">Instant</option>
            <option value="juno">Juno</option>
            <option value="lark">Lark</option>
            <option value="mayfair">Mayfair</option>
            <option value="moon">Moon</option>
            <option value="nashville">Nashville</option>
            <option value="reyes">Reyes</option>
            <option value="slumber">Slumber</option>
            <option value="stinson">Stinson</option>
            <option value="toaster">Toaster</option>
            <option value="valencia">Valencia</option>
            <option value="walden">Walden</option>
            <option value="willow">Willow</option>
            <option value="xpro2">X-Pro II</option>
            <option value="warm">Ấm áp (Warm)</option>
            <option value="cool">Mát mẻ (Cool)</option>
            <option value="dramatic">Kịch tính (Dramatic)</option>
            <option value="soft">Nhẹ nhàng (Soft)</option>
            <option value="vintage">Cổ điển (Vintage)</option>
            <option value="high-contrast">Tương phản cao</option>
            <option value="low-key">Tối (Low Key)</option>
            <option value="high-key">Sáng (High Key)</option>
          </select>
          
          <button onclick="resetColor()" style="
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
          ">Đặt lại màu sắc</button>
        </div>
      </div>

      <div id="text" class="control-group hidden">
        <div class="coming-soon">
          <i class="fas fa-tools"></i>
          <h4>Đang phát triển</h4>
          <p>Tính năng thêm văn bản sẽ sớm có mặt</p>
        </div>
      </div>

      <div id="draw" class="control-group hidden">
        <div class="coming-soon">
          <i class="fas fa-paint-brush"></i>
          <h4>Đang phát triển</h4>
          <p>Tính năng vẽ tự do sẽ sớm có mặt</p>
        </div>
      </div>
    </div>

    <!-- Canvas Panel -->
    <div class="canvas-container">
      <div class="canvas-wrapper">
        <div class="canvas-header">
          <div class="canvas-title">Chỉnh sửa ảnh</div>
          <div class="file-input-wrapper">
            <input type="file" accept="image/*" onchange="loadImage(this)" class="file-input" id="fileInput">
            <label for="fileInput" class="upload-btn">
              <i class="fas fa-upload"></i>
              Chọn ảnh
            </label>
          </div>
        </div>
        
        <div id="canvas-placeholder" class="placeholder">
          <i class="fas fa-image"></i>
          <div>Chọn một ảnh để bắt đầu chỉnh sửa</div>
        </div>
        
        <canvas id="canvas" class="hidden"></canvas>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/caman@4.1.2/dist/caman.full.min.js"></script>
  <script>
    function showMenu(id) {
      // Hide all control groups
      document.querySelectorAll('.control-group').forEach(group => {
        group.classList.add('hidden');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected control group
      const selectedGroup = document.getElementById(id);
      if (selectedGroup) {
        selectedGroup.classList.remove('hidden');
      }
      
      // Add active class to clicked nav item
      event.currentTarget.classList.add('active');
    }

    function loadImage(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.getElementById('canvas');
          const placeholder = document.getElementById('canvas-placeholder');
          
          if (!canvas) {
            console.error('Canvas element not found');
            return;
          }
          
          try {
            // Set canvas size
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw image
            const ctx = canvas.getContext('2d');
            if (!ctx) {
              console.error('Could not get 2D context');
              return;
            }
            ctx.drawImage(img, 0, 0);
            
            // Show canvas, hide placeholder
            canvas.classList.remove('hidden');
            placeholder.classList.add('hidden');
          } catch (error) {
            console.error('Lỗi khi load ảnh:', error);
            alert('Có lỗi xảy ra khi load ảnh. Vui lòng thử lại.');
          }
        };
        img.onerror = function() {
          console.error('Lỗi khi load ảnh');
          alert('Không thể load ảnh. Vui lòng thử lại với ảnh khác.');
        };
        img.src = e.target.result;
      };
      reader.onerror = function() {
        console.error('Lỗi khi đọc file');
        alert('Không thể đọc file. Vui lòng thử lại.');
      };
      reader.readAsDataURL(file);
    }

    function applyFilter(name) {
      if (!name) return;
      
      if (!isCanvasReady()) {
        alert('Vui lòng chọn một ảnh trước khi áp dụng hiệu ứng');
        return;
      }
      
      const success = safeCaman(function () {
        this.revert(false);
        this[name]().render();
        
        // After applying filter, reset lighting controls to avoid conflicts
        resetLightingControls();
      });
      
      if (!success) {
        alert('Có lỗi xảy ra khi áp dụng hiệu ứng. Vui lòng thử lại.');
      }
    }
    
    function resetLightingControls() {
      // Reset lighting sliders without applying changes
      document.querySelector('input[oninput*="brightness"]').value = 0;
      document.querySelector('input[oninput*="contrast"]').value = 0;
      document.querySelector('input[oninput*="exposure"]').value = 0;
      document.querySelector('input[oninput*="highlights"]').value = 0;
      document.querySelector('input[oninput*="shadows"]').value = 0;
      document.querySelector('input[oninput*="temperature"]').value = 0;
      document.querySelector('input[oninput*="gamma"]').value = 1.0;
      
      // Update display values
      document.getElementById('brightness-value').textContent = '0';
      document.getElementById('contrast-value').textContent = '0';
      document.getElementById('exposure-value').textContent = '0';
      document.getElementById('highlights-value').textContent = '0';
      document.getElementById('shadows-value').textContent = '0';
      document.getElementById('temperature-value').textContent = '0';
      document.getElementById('gamma-value').textContent = '1.0';
    }

    function adjust(type, value) {
      Caman("#canvas", function () {
        this.revert(false);
        this[type](parseInt(value)).render();
      });
      
      // Update display value
      const valueElement = document.getElementById(type + '-value');
      if (valueElement) {
        if (type === 'hue') {
          valueElement.textContent = value + '°';
        } else {
          valueElement.textContent = value;
        }
      }
    }

    function adjustColor(type, value) {
      if (!isCanvasReady()) {
        return;
      }
      
      safeCaman(function () {
        this.revert(false);
        
        // Apply all current color adjustments
        const hue = document.querySelector('input[oninput*="hue"]').value;
        const saturation = document.querySelector('input[oninput*="saturation"]').value;
        const lightness = document.querySelector('input[oninput*="lightness"]').value;
        const colorContrast = document.querySelector('input[oninput*="colorContrast"]').value;
        const colorSharpness = document.querySelector('input[oninput*="colorSharpness"]').value;
        const colorBlur = document.querySelector('input[oninput*="colorBlur"]').value;
        const colorNoise = document.querySelector('input[oninput*="colorNoise"]').value;
        const colorSeparation = document.querySelector('input[oninput*="colorSeparation"]').value;
        const colorTransition = document.querySelector('input[oninput*="colorTransition"]').value;
        const warmth = document.querySelector('input[oninput*="warmth"]').value;
        const vibrance = document.querySelector('input[oninput*="vibrance"]').value;
        const opacity = document.querySelector('input[oninput*="opacity"]').value;
        const clarity = document.querySelector('input[oninput*="clarity"]').value;
        
        // Apply basic color adjustments
        if (parseFloat(hue) !== 0) this.hue(parseFloat(hue));
        if (parseFloat(saturation) !== 0) this.saturation(parseFloat(saturation));
        if (parseFloat(lightness) !== 0) this.lightness(parseFloat(lightness));
        
        // Apply advanced color effects
        if (parseFloat(colorContrast) !== 0) this.contrast(parseFloat(colorContrast));
        if (parseFloat(colorSharpness) !== 0) this.sharpen(parseFloat(colorSharpness));
        if (parseFloat(colorBlur) !== 0) this.blur(parseFloat(colorBlur));
        if (parseFloat(colorNoise) !== 0) this.noise(parseFloat(colorNoise));
        if (parseFloat(colorSeparation) !== 0) this.channelSeparation(parseFloat(colorSeparation));
        if (parseFloat(colorTransition) !== 0) this.colorTransition(parseFloat(colorTransition));
        
        // Apply warmth (temperature adjustment)
        if (parseFloat(warmth) !== 0) this.temperature(parseFloat(warmth));
        
        // Apply vibrance (enhanced saturation for muted colors)
        if (parseFloat(vibrance) !== 0) this.vibrance(parseFloat(vibrance));
        
        // Apply opacity
        if (parseFloat(opacity) !== 100) this.opacity(parseFloat(opacity) / 100);
        
        // Apply clarity
        if (parseFloat(clarity) !== 0) this.clarity(parseFloat(clarity));
        
        this.render();
      });
      
      // Update display value
      const valueElement = document.getElementById(type + '-value');
      if (valueElement) {
        if (type === 'hue') {
          valueElement.textContent = value + '°';
        } else if (type === 'colorSharpness' || type === 'colorBlur' || type === 'colorNoise' || type === 'colorSeparation' || type === 'colorTransition') {
          valueElement.textContent = parseFloat(value).toFixed(1);
        } else if (type === 'opacity') {
          valueElement.textContent = parseFloat(value).toFixed(0) + '%';
        } else {
          valueElement.textContent = parseFloat(value).toFixed(0);
        }
      }
    }

    function resetColor() {
      const canvas = document.getElementById('canvas');
      if (!canvas || canvas.classList.contains('hidden')) {
        return;
      }
      
      // Reset all color sliders to default values
      document.querySelector('input[oninput*="hue"]').value = 0;
      document.querySelector('input[oninput*="saturation"]').value = 0;
      document.querySelector('input[oninput*="lightness"]').value = 0;
      document.querySelector('input[oninput*="colorContrast"]').value = 0;
      document.querySelector('input[oninput*="colorSharpness"]').value = 0;
      document.querySelector('input[oninput*="colorBlur"]').value = 0;
      document.querySelector('input[oninput*="colorNoise"]').value = 0;
      document.querySelector('input[oninput*="colorSeparation"]').value = 0;
      document.querySelector('input[oninput*="colorTransition"]').value = 0;
      document.querySelector('input[oninput*="warmth"]').value = 0;
      document.querySelector('input[oninput*="vibrance"]').value = 0;
      document.querySelector('input[oninput*="opacity"]').value = 100;
      document.querySelector('input[oninput*="clarity"]').value = 0;
      
      // Reset the image
      try {
        Caman("#canvas", function () {
          this.revert(false).render();
        });
      } catch (error) {
        console.error('Lỗi khi đặt lại màu sắc:', error);
      }
      
      // Update all display values
      document.getElementById('hue-value').textContent = '0°';
      document.getElementById('saturation-value').textContent = '0';
      document.getElementById('lightness-value').textContent = '0';
      document.getElementById('colorContrast-value').textContent = '0';
      document.getElementById('colorSharpness-value').textContent = '0';
      document.getElementById('colorBlur-value').textContent = '0';
      document.getElementById('colorNoise-value').textContent = '0';
      document.getElementById('colorSeparation-value').textContent = '0';
      document.getElementById('colorTransition-value').textContent = '0';
      document.getElementById('warmth-value').textContent = '0';
      document.getElementById('vibrance-value').textContent = '0';
      document.getElementById('opacity-value').textContent = '100%';
      document.getElementById('clarity-value').textContent = '0';
    }

    function applyColorPreset(preset) {
      if (!preset) return;
      
      const presets = {
        'vibrant': { saturation: 30, lightness: 10, colorContrast: 20, vibrance: 25 },
        'muted': { saturation: -30, lightness: -10, colorContrast: -10, vibrance: -20 },
        'sepia': { hue: 30, saturation: -20, lightness: -10, warmth: 25 },
        'blackwhite': { saturation: -100, colorContrast: 15 },
        'crossProcess': { hue: 15, saturation: 25, colorContrast: 15, warmth: 10 },
        'chrome': { saturation: 40, colorContrast: 25, colorSharpness: 20, vibrance: 30 },
        'fade': { saturation: -40, lightness: 20, colorBlur: 2, opacity: 80 },
        'instant': { saturation: 20, colorContrast: 15, colorNoise: 10, vibrance: 15 },
        'juno': { hue: 10, saturation: 15, lightness: 5, warmth: 15 },
        'lark': { saturation: -20, lightness: 10, colorContrast: 10, vibrance: -10 },
        'mayfair': { saturation: 25, colorContrast: 20, colorSharpness: 15, vibrance: 20 },
        'moon': { saturation: -80, lightness: 15, colorContrast: 25, colorBlur: 1 },
        'nashville': { hue: 5, saturation: 15, lightness: -5, warmth: 10 },
        'reyes': { saturation: -10, lightness: 15, colorContrast: 10, vibrance: -5 },
        'slumber': { saturation: -30, lightness: 10, colorBlur: 3, opacity: 90 },
        'stinson': { saturation: -20, lightness: 5, colorContrast: 5, vibrance: -15 },
        'toaster': { hue: 20, saturation: 30, lightness: -10, warmth: 20 },
        'valencia': { saturation: 15, lightness: 10, colorContrast: 15, vibrance: 10 },
        'walden': { hue: 15, saturation: 20, lightness: 5, warmth: 15 },
        'willow': { saturation: -25, lightness: 15, colorContrast: 10, vibrance: -10 },
        'xpro2': { hue: 10, saturation: 25, colorContrast: 20, vibrance: 25 },
        'warm': { warmth: 30, vibrance: 15, saturation: 10 },
        'cool': { warmth: -20, vibrance: -10, saturation: -5 },
        'dramatic': { colorContrast: 40, vibrance: 30, colorSharpness: 25, clarity: 20 },
        'soft': { colorBlur: 2, vibrance: -20, saturation: -15, clarity: -10 },
        'vintage': { hue: 15, saturation: -10, warmth: 25, colorBlur: 1, clarity: 5 },
        'high-contrast': { colorContrast: 50, vibrance: 40, colorSharpness: 30, clarity: 25 },
        'low-key': { lightness: -20, colorContrast: 25, vibrance: -30, clarity: 15 },
        'high-key': { lightness: 25, vibrance: 20, colorBlur: 1, clarity: 10 }
      };
      
      const presetValues = presets[preset];
      if (!presetValues) return;
      
      // Update sliders
      document.querySelector('input[oninput*="hue"]').value = presetValues.hue || 0;
      document.querySelector('input[oninput*="saturation"]').value = presetValues.saturation || 0;
      document.querySelector('input[oninput*="lightness"]').value = presetValues.lightness || 0;
      document.querySelector('input[oninput*="colorContrast"]').value = presetValues.colorContrast || 0;
      document.querySelector('input[oninput*="colorSharpness"]').value = presetValues.colorSharpness || 0;
      document.querySelector('input[oninput*="colorBlur"]').value = presetValues.colorBlur || 0;
      document.querySelector('input[oninput*="colorNoise"]').value = presetValues.colorNoise || 0;
      document.querySelector('input[oninput*="colorSeparation"]').value = presetValues.colorSeparation || 0;
      document.querySelector('input[oninput*="colorTransition"]').value = presetValues.colorTransition || 0;
      document.querySelector('input[oninput*="warmth"]').value = presetValues.warmth || 0;
      document.querySelector('input[oninput*="vibrance"]').value = presetValues.vibrance || 0;
      document.querySelector('input[oninput*="opacity"]').value = presetValues.opacity || 100;
      document.querySelector('input[oninput*="clarity"]').value = presetValues.clarity || 0;
      
              // Apply the preset
        try {
          Caman("#canvas", function () {
            this.revert(false);
            
            if (presetValues.hue) this.hue(presetValues.hue);
            if (presetValues.saturation) this.saturation(presetValues.saturation);
            if (presetValues.lightness) this.lightness(presetValues.lightness);
            if (presetValues.colorContrast) this.contrast(presetValues.colorContrast);
            if (presetValues.colorSharpness) this.sharpen(presetValues.colorSharpness);
            if (presetValues.colorBlur) this.blur(presetValues.colorBlur);
            if (presetValues.colorNoise) this.noise(presetValues.colorNoise);
            if (presetValues.colorSeparation) this.channelSeparation(presetValues.colorSeparation);
            if (presetValues.colorTransition) this.colorTransition(presetValues.colorTransition);
            if (presetValues.warmth) this.temperature(presetValues.warmth);
            if (presetValues.vibrance) this.vibrance(presetValues.vibrance);
            if (presetValues.opacity) this.opacity(presetValues.opacity / 100);
            if (presetValues.clarity) this.clarity(presetValues.clarity);
            
            this.render();
          });
        } catch (error) {
          console.error('Lỗi khi áp dụng preset màu sắc:', error);
        }
        
        // Update display values
        document.getElementById('hue-value').textContent = (presetValues.hue || 0) + '°';
        document.getElementById('saturation-value').textContent = (presetValues.saturation || 0).toString();
        document.getElementById('lightness-value').textContent = (presetValues.lightness || 0).toString();
        document.getElementById('colorContrast-value').textContent = (presetValues.colorContrast || 0).toString();
        document.getElementById('colorSharpness-value').textContent = (presetValues.colorSharpness || 0).toString();
        document.getElementById('colorBlur-value').textContent = (presetValues.colorBlur || 0).toString();
        document.getElementById('colorNoise-value').textContent = (presetValues.colorNoise || 0).toString();
        document.getElementById('colorSeparation-value').textContent = (presetValues.colorSeparation || 0).toString();
        document.getElementById('colorTransition-value').textContent = (presetValues.colorTransition || 0).toString();
        document.getElementById('warmth-value').textContent = (presetValues.warmth || 0).toString();
        document.getElementById('vibrance-value').textContent = (presetValues.vibrance || 0).toString();
        document.getElementById('opacity-value').textContent = (presetValues.opacity || 100).toString() + '%';
        document.getElementById('clarity-value').textContent = (presetValues.clarity || 0).toString();
    }

    function adjustLighting(type, value) {
      const canvas = document.getElementById('canvas');
      if (!canvas || canvas.classList.contains('hidden')) {
        return;
      }
      
      try {
        Caman("#canvas", function () {
          this.revert(false);
          
          // Apply all current lighting adjustments
          const brightness = document.querySelector('input[oninput*="brightness"]').value;
          const contrast = document.querySelector('input[oninput*="contrast"]').value;
          const exposure = document.querySelector('input[oninput*="exposure"]').value;
          const highlights = document.querySelector('input[oninput*="highlights"]').value;
          const shadows = document.querySelector('input[oninput*="shadows"]').value;
          const temperature = document.querySelector('input[oninput*="temperature"]').value;
          const gamma = document.querySelector('input[oninput*="gamma"]').value;
          
          this.brightness(parseFloat(brightness))
              .contrast(parseFloat(contrast))
              .exposure(parseFloat(exposure))
              .highlights(parseFloat(highlights))
              .shadows(parseFloat(shadows))
              .temperature(parseFloat(temperature))
              .gamma(parseFloat(gamma))
              .render();
        });
      } catch (error) {
        console.error('Lỗi khi điều chỉnh ánh sáng:', error);
      }
      
      // Update display value
      const valueElement = document.getElementById(type + '-value');
      if (valueElement) {
        if (type === 'gamma') {
          valueElement.textContent = parseFloat(value).toFixed(1);
        } else {
          valueElement.textContent = parseFloat(value).toFixed(0);
        }
      }
    }

    function resetLighting() {
      const canvas = document.getElementById('canvas');
      if (!canvas || canvas.classList.contains('hidden')) {
        return;
      }
      
      // Reset all sliders to default values
      document.querySelector('input[oninput*="brightness"]').value = 0;
      document.querySelector('input[oninput*="contrast"]').value = 0;
      document.querySelector('input[oninput*="exposure"]').value = 0;
      document.querySelector('input[oninput*="highlights"]').value = 0;
      document.querySelector('input[oninput*="shadows"]').value = 0;
      document.querySelector('input[oninput*="temperature"]').value = 0;
      document.querySelector('input[oninput*="gamma"]').value = 1.0;
      
      // Reset the image
      try {
        Caman("#canvas", function () {
          this.revert(false).render();
        });
      } catch (error) {
        console.error('Lỗi khi đặt lại ánh sáng:', error);
      }
      
      // Update all display values
      document.getElementById('brightness-value').textContent = '0';
      document.getElementById('contrast-value').textContent = '0';
      document.getElementById('exposure-value').textContent = '0';
      document.getElementById('highlights-value').textContent = '0';
      document.getElementById('shadows-value').textContent = '0';
      document.getElementById('temperature-value').textContent = '0';
      document.getElementById('gamma-value').textContent = '1.0';
    }

    function applyLightingPreset(preset) {
      if (!preset) return;
      
      const presets = {
        'warm': { brightness: 10, contrast: 15, temperature: 20, gamma: 1.1 },
        'cool': { brightness: 5, contrast: 10, temperature: -15, gamma: 0.9 },
        'dramatic': { brightness: -10, contrast: 30, shadows: -20, highlights: 15, gamma: 1.2 },
        'soft': { brightness: 15, contrast: -10, highlights: 20, shadows: 10, gamma: 0.8 },
        'vintage': { brightness: 5, contrast: 20, temperature: 25, gamma: 1.3 },
        'high-contrast': { brightness: 0, contrast: 40, highlights: 30, shadows: -30, gamma: 1.4 },
        'low-key': { brightness: -20, contrast: 25, shadows: -30, highlights: -10, gamma: 1.1 },
        'high-key': { brightness: 25, contrast: -5, highlights: 30, shadows: 15, gamma: 0.9 }
      };
      
      const presetValues = presets[preset];
      if (!presetValues) return;
      
      // Update sliders
      document.querySelector('input[oninput*="brightness"]').value = presetValues.brightness || 0;
      document.querySelector('input[oninput*="contrast"]').value = presetValues.contrast || 0;
      document.querySelector('input[oninput*="exposure"]').value = presetValues.exposure || 0;
      document.querySelector('input[oninput*="highlights"]').value = presetValues.highlights || 0;
      document.querySelector('input[oninput*="shadows"]').value = presetValues.shadows || 0;
      document.querySelector('input[oninput*="temperature"]').value = presetValues.temperature || 0;
      document.querySelector('input[oninput*="gamma"]').value = presetValues.gamma || 1.0;
      
      // Apply the preset
      try {
        Caman("#canvas", function () {
          this.revert(false);
          this.brightness(presetValues.brightness || 0)
              .contrast(presetValues.contrast || 0)
              .exposure(presetValues.exposure || 0)
              .highlights(presetValues.highlights || 0)
              .shadows(presetValues.shadows || 0)
              .temperature(presetValues.temperature || 0)
              .gamma(presetValues.gamma || 1.0)
              .render();
        });
      } catch (error) {
        console.error('Lỗi khi áp dụng preset ánh sáng:', error);
      }
      
      // Update display values
      document.getElementById('brightness-value').textContent = (presetValues.brightness || 0).toString();
      document.getElementById('contrast-value').textContent = (presetValues.contrast || 0).toString();
      document.getElementById('exposure-value').textContent = (presetValues.exposure || 0).toString();
      document.getElementById('highlights-value').textContent = (presetValues.highlights || 0).toString();
      document.getElementById('shadows-value').textContent = (presetValues.shadows || 0).toString();
      document.getElementById('temperature-value').textContent = (presetValues.temperature || 0).toString();
      document.getElementById('gamma-value').textContent = (presetValues.gamma || 1.0).toFixed(1);
    }

    function updateLightingValues() {
      // This function is kept for compatibility but not used in the current implementation
      // The values are updated directly in adjustLighting function
    }

    function exportImage() {
      const canvas = document.getElementById('canvas');
      if (!canvas || canvas.classList.contains('hidden')) {
        alert('Vui lòng chọn một ảnh để xuất');
        return;
      }
      
      try {
        const link = document.createElement('a');
        link.download = 'magic-image-edited.png';
        link.href = canvas.toDataURL();
        link.click();
      } catch (error) {
        console.error('Lỗi khi xuất ảnh:', error);
        alert('Có lỗi xảy ra khi xuất ảnh. Vui lòng thử lại.');
      }
    }

    // Initialize with filters menu
    document.addEventListener('DOMContentLoaded', function() {
      showMenu('filters');
      
      // Check if Caman is loaded
      if (typeof Caman === 'undefined') {
        console.warn('Caman library chưa được load. Vui lòng kiểm tra kết nối internet.');
      }
    });
    
    // Helper function to check if canvas is ready
    function isCanvasReady() {
      const canvas = document.getElementById('canvas');
      return canvas && !canvas.classList.contains('hidden') && canvas.width > 0 && canvas.height > 0;
    }
    
    // Helper function to safely call Caman
    function safeCaman(callback) {
      if (typeof Caman === 'undefined') {
        console.error('Caman library chưa được load');
        alert('Caman library chưa được load. Vui lòng kiểm tra kết nối internet và tải lại trang.');
        return false;
      }
      
      if (!isCanvasReady()) {
        console.warn('Canvas chưa sẵn sàng');
        return false;
      }
      
      try {
        Caman("#canvas", callback);
        return true;
      } catch (error) {
        console.error('Lỗi khi gọi Caman:', error);
        return false;
      }
    }
  </script>
</body>
</html>
